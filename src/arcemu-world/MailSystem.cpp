/*
 * ArcEmu MMORPG Server
 * Copyright (C) 2005-2007 Ascent Team <http://www.ascentemu.com/>
 * Copyright (C) 2008 <http://www.ArcEmu.org/>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 */

#include "StdAfx.h"
initialiseSingleton(MailSystem);

void MailSystem::StartMailSystem()
{

}

MailError MailSystem::DeliverMessage(uint64 recipent, MailMessage* message)
{
	// assign a new id
	message->message_id = Generate_Message_Id();

	Player * plr = objmgr.GetPlayer((uint32)recipent);
	if(plr != NULL)
	{
		plr->m_mailBox.AddMessage(message);
		if((uint32)UNIXTIME >= message->delivery_time)
		{
			uint32 v = 0;
			plr->GetSession()->OutPacket(SMSG_RECEIVED_MAIL, 4, &v);
		}
	}

	SaveMessageToSQL(message);
	return MAIL_OK;
}

void Mailbox::AddMessage(MailMessage* Message)
{
	Messages[Message->message_id] = *Message;
}

void Mailbox::DeleteMessage(uint32 MessageId, bool sql)
{
	Messages.erase(MessageId);
	if(sql)
		CharacterDatabase.WaitExecute("DELETE FROM mailbox WHERE message_id = %u", MessageId);
}

WorldPacket * Mailbox::BuildMailboxListingPacket()
{
	/*
	24 mails 
{SERVER} Packet: (0x023B) SMSG_MAIL_LIST_RESULT PacketSize = 4325 TimeStamp = 31645068
18 00 00 00 18 B4 00 C6 FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 AC FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 FA 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 81 FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9A FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 B0 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 3B FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 88 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 75 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 0C FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 7C FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 32 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 E8 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 70 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 13 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 97 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D8 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 79 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 51 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 C4 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 47 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 3F FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 03 8C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 FF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 2D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 4C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 DF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 21 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 29 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8E FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 02 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4F 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 5A FA 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9B FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 A4 4E 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8C F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 58 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 62 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 46 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 92 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 38 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 34 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 35 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 F8 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 1C FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 F4 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A5 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 03 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 AA 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 61 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 EB FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 66 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 15 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 D3 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 1F 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 C3 F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 B5 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 CB 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 7D F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 A2 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 94 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 2F F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 27 68 2B 32 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 8A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 48 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A2 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D4 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 04 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 29 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 0F 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
//3 mails 3.3.3
03 00 00 00 
03 
47 01 8A 06 43 69 03 17 71 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 87 FF EF 41 00 00 00 00 43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 01 00 AA FB 46 47 AD A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 E0 E9 45 1B 01 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 AE 00 5F F6 42 69 00 6E DD FC 01 00 00 00 04 65 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 0A E2 3F 40 00 00 00 00 74 65 73 74 31 00 74 65 73 74 31 00 01 00 85 EB 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AC 00 94 E8 42 69 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 29 00 00 00 65 00 00 00 10 00 00 00 87 F9 F7 41 00 00 00 00 74 65 73 74 00 74 65 73 74 00 01 00 A7 DC 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
*/
	WorldPacket * data = new WorldPacket(SMSG_MAIL_LIST_RESULT, 500);
	MessageMap::iterator itr;
	uint32 count = 0;
	uint32 t = (uint32)UNIXTIME;
	*data << uint32( Messages.size() );	 // mail count including unsent ones
	*data << uint8(count);	 // size placeholder

	for(itr = Messages.begin(); itr != Messages.end(); ++itr)
	{
		if(itr->second.expire_time && t > itr->second.expire_time)
			continue;	   // expired mail -> skip it

		if((uint32)UNIXTIME < itr->second.delivery_time)
			continue;		// undelivered
		
		if(itr->second.AddMessageDataToPacket(*data))
			++count;
		
		if(count == 18)
			break;
	}

	const_cast<uint8*>(data->contents())[4] = count;

	// do cleanup on request mail
	CleanupExpiredMessages();
	return data;
}

void Mailbox::CleanupExpiredMessages()
{
	MessageMap::iterator itr, it2;
	uint32 curtime = (uint32)UNIXTIME;

	for(itr = Messages.begin(); itr != Messages.end();)
	{
		it2 = itr++;
		if(it2->second.expire_time && it2->second.expire_time < curtime)
			DeleteMessage( it2->second.message_id, true ); // !changes list !
	}
}

bool MailMessage::AddMessageDataToPacket(WorldPacket& data)
{
	uint8 i = 0;
	uint32 j;
	size_t pos;
	vector<uint64>::iterator itr;
	Item * pItem;

/*
{SERVER} Packet: (0x023B) SMSG_MAIL_LIST_RESULT PacketSize = 4325 TimeStamp = 31645068
18 00 00 00 - real mail count
18 - mail count

B4 00 
C6 FD 87 53
00 message_id
6E DD FC 01 00 00 00 04 sender_guid
00 00 00 00 cod
00 00 00 00 message_id
00 00 00 00 ?
29 00 00 00 stationery
00 00 00 00 money
00 00 00 00 message_type
AC FE F7 41 expire_time
00 00 00 00 ?
43 6F 61 72 73 65 20 54 68 72 65 61 64 00 subject
01 items
00 index
FA 51 7D 31 guid
10 09 00 00 entry
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 enchants
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 ITEM_FIELD_RANDOM_PROPERTIES_ID
00 00 00 00 GetItemRandomSuffixFactor
00 00 00 00 ITEM_FIELD_STACK_COUNT
00 00 00 00 GetChargesLeft
00 00 00 00 ITEM_FIELD_MAXDURABILITY
01 00 00 00 ITEM_FIELD_DURABILITY
00 ?
B4 00 
81 FD 87 53
00 
6E DD FC 01 00 00 00 04
00 00 00 00 
00 00 00 00
00 00 00 00
29 00 00 00
00 00 00 00 
00 00 00 00 
9A FE F7 41 
00 00 00 00
43 6F 61 72 73 65 20 54 68 72 65 61 64 00 
01 
00 
B0 51 7D 31
10 09 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 
00 00 00 00 
01 00 00 00 
00 00 00 00 
00 00 00 00 
00 00 00 00 
00 
B4 00 3B FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 88 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 75 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 0C FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 7C FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 32 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 E8 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 70 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 13 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 97 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D8 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 79 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 51 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 C4 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 47 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 3F FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 03 8C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 FF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 2D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 4C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 DF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 21 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 29 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8E FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 02 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4F 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 5A FA 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9B FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 A4 4E 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8C F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 58 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 62 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 46 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 92 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 38 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 34 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 35 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 F8 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 1C FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 F4 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A5 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 03 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 AA 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 61 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 EB FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 66 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 15 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 D3 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 1F 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 C3 F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 B5 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 CB 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 7D F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 A2 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 94 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 2F F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 27 68 2B 32 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 8A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 48 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A2 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D4 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 04 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 29 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 0F 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

//3.3.3
47 01 - magic
8A 06 43 69 id
03 type
17 71 00 00 guid
00 00 00 00 cod
00 00 00 00 ?
29 00 00 00 stationery
00 00 00 00 gold
10 00 00 00 non auction mail
87 FF EF 41 remaining days
00 00 00 00 mail template
43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 - subject
48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 - body
01 - 1 item
00 - subindex
AA FB 46 47 guid
AD A0 00 00 entry
00 00 00 00 00 00 00 00 00 00 00 00 enchant 1
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 random prop
E0 E9 45 1B random suff
01 00 00 00 stack
FF FF FF FF charges
00 00 00 00 maxdur
00 00 00 00 dur
00 ?
AE 00 
5F F6 42 69 
00 
6E DD FC 01 00 00 00 04
65 00 00 00
00 00 00 00 
29 00 00 00 
00 00 00 00 
10 00 00 00 
0A E2 3F 40 00 00 00 00 74 65 73 74 31 00 74 65 73 74 31 00 01 00 85 EB 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AC 00 94 E8 42 69 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 29 00 00 00 65 00 00 00 10 00 00 00 87 F9 F7 41 00 00 00 00 74 65 73 74 00 74 65 73 74 00 01 00 A7 DC 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
*/
	// add stuff
	if(deleted_flag)
	{ 
		return false;
	}

	data << uint16(0x0032);
	data << message_id;
	data << uint8(message_type);	//blizz employe mail ?
	if(message_type)
		data << uint32(sender_guid);
	else
		data << sender_guid;

	data << cod;			// cod
//	data << message_id;		// itempageid
	data << uint32(0);
	data << stationery;
	data << money;		// money
	data << uint32((message_type == AUCTION ? 0x04 : 0x10));
	data << float(float(expire_time - (uint32)UNIXTIME) / (60*60*24.0f) );
	data << uint32(0); //mail template (MailTemplate.dbc)
	data << subject;
	data << body;
	pos = data.wpos();
	data << uint8(0);		// item count

	if( !items.empty( ) )
	{
		for( itr = items.begin( ); itr != items.end( ); ++itr )
		{
			pItem = objmgr.LoadItem( *itr );
			if( pItem == NULL )
				continue;

			data << uint8(i++);
			data << pItem->GetUInt32Value(OBJECT_FIELD_GUID);
			data << pItem->GetEntry();

			for( j = 0; j < 7; ++j )
			{
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_1 + ( j * 3 ) );
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_2 + ( j * 3 ) );
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_3 + ( j * 3 ) );
			}

			data << pItem->GetUInt32Value( ITEM_FIELD_RANDOM_PROPERTIES_ID );
			if( ( (int32)pItem->GetUInt32Value( ITEM_FIELD_RANDOM_PROPERTIES_ID ) ) < 0 )
                data << pItem->GetItemRandomSuffixFactor();
			else
				data << uint32( 0 );

//			data << uint8( pItem->GetUInt32Value(ITEM_FIELD_STACK_COUNT) );
			data << uint32( pItem->GetUInt32Value(ITEM_FIELD_STACK_COUNT) );
			data << uint32( pItem->GetChargesLeft() );
			data << pItem->GetUInt32Value( ITEM_FIELD_MAXDURABILITY );
			data << pItem->GetUInt32Value( ITEM_FIELD_DURABILITY );
			data << uint8( 0 );
			//we are done using this item. Now we can delete it ?
			//pItem->DeleteMe();
			pItem = NULL;
		}

		data.put< uint8 >( pos, i );
	}

	return true;
/*
	data << uint16(0);
	data << message_id;
	data << uint8(message_type);
	if(message_type)
		data << uint32(sender_guid);
	else
		data << sender_guid;

	data << subject;
	data << message_id;	  // itempageid
	data << message_id;

	data << stationery;

	uint32 itementry = 0, itemcount = 0;
	uint32 charges = 0, durability = 0, maxdurability = 0;

	if(attached_item_guid)
	{
		QueryResult * result = CharacterDatabase.Query("SELECT `entry`, `count`, `charges`, `durability` FROM playeritems WHERE guid='%u'", GUID_LOPART(attached_item_guid));
		if(result)
		{
			itementry = result->Fetch()[0].GetUInt32();
			itemcount = result->Fetch()[1].GetUInt32();
			charges = result->Fetch()[2].GetUInt32();
			durability = result->Fetch()[3].GetUInt32();
			ItemPrototype * it = ItemPrototypeStorage.LookupEntry(itementry);
			maxdurability = it ? it->MaxDurability : durability;

			delete result;
		}
	}

	if(external_attached_item_guid)
	{
		QueryResult * result = CharacterDatabase.Query("SELECT `entry`, `count`, `charges`, `durability` FROM playeritems_external WHERE guid='%u'", GUID_LOPART(external_attached_item_guid));
		if(result)
		{
			itementry = result->Fetch()[0].GetUInt32();
			itemcount = result->Fetch()[1].GetUInt32();
			charges = result->Fetch()[2].GetUInt32();
			durability = result->Fetch()[3].GetUInt32();
			ItemPrototype * it = ItemPrototypeStorage.LookupEntry(itementry);
			maxdurability = it ? it->MaxDurability : durability;

			delete result;
		}
	}

	data << itementry;
	data << uint32(0);  // unk
	data << uint32(0);  // unk
	data << uint32(0);  // unk
	for(uint32 i = 0; i < 17; ++i)
		data << uint32(0);

	data << (itemcount ? uint8(itemcount) : uint8(1));
	data << charges;
	data << maxdurability;
	data << durability;
	data << money;
	data << cod;
	data << uint32(read_flag);

	if(expire_time)
		data << float(float(expire_time - (uint32)UNIXTIME) / 86400.0f);
	else
		data << float(0);

	data << uint32(0);

	return true;*/
}

void MailSystem::SaveMessageToSQL(MailMessage * message)
{
	stringstream ss;
	vector< uint64 >::iterator itr;
	ss << "REPLACE INTO mailbox VALUES("
		<< message->message_id << ","
		<< message->message_type << ","
		<< message->player_guid << ","
		<< message->sender_guid << ",\""
		<< CharacterDatabase.EscapeString(message->subject) << "\",\""
		<< CharacterDatabase.EscapeString(message->body) << "\","
		<< message->money << ",'";

	for( itr = message->items.begin( ); itr != message->items.end( ); ++itr )
		ss << (*itr) << ",";

	ss << "'," 
		<< message->cod << ","
		<< message->stationery << ","
		<< message->expire_time << ","
		<< message->delivery_time << ","
		<< message->copy_made << ","
		<< message->read_flag << ","
		<< message->deleted_flag << ")";
	CharacterDatabase.WaitExecute(ss.str().c_str());
}

void WorldSession::HandleSendMail(WorldPacket & recv_data )
{

	/*
	320 client
{CLIENT} Packet: (0x0238) CMSG_SEND_MAIL PacketSize = 60 TimeStamp = 31476306
54 0E 00 03 33 02 10 F1 
61 00 
43 6F 61 72 73 65 20 54 68 72 65 61 64 00
00
29 00 00 00 
00 00 00 00 
01 -itemcount
00 -slot
A8 20 DA E3 01 00 00 44 guid
00 00 00 00 
00 00 00 00 
00 00 00 00 ?
00 00 00 00 ?
00 ?
*/
	MailMessage msg;
	uint64 gameobject;
	uint32 unk2;
	uint8 itemcount;
	uint8 itemslot;
	uint8 i;
	uint64 itemguid;
	vector< Item* > items;
	vector< Item* >::iterator itr;
	string recepient;
	Item * pItem;
	//uint32 err = MAIL_OK;

	recv_data >> gameobject >> recepient;
	recv_data >> msg.subject >> msg.body >> msg.stationery;
	recv_data >> unk2 >> itemcount;

	//he simply ads ' ' after each '%' to string so that vsnprintf function would not find tokens in string
	char *t=(char*)msg.subject.c_str();
	if( t[0] != 0 ) //if not an empty string
	{
		uint32 ind=0;
		size_t maxlen = strlen( t ); //let's hope we can find the string terminator
		//make sure we do not have any recognizable tokens here
		while(t[ind]!=0 && ind<maxlen)
		{
			if(t[ind]=='%')
				*(unsigned char *)&t[ind]='P';//just remove chars that could be interpreted
			ind++;
		}
	}
	msg.subject = t;
	t=(char*)msg.body.c_str();
	if( t[0] != 0 ) //if not an empty string
	{
		uint32 ind=0;
		size_t maxlen = strlen( t );//let's hope we can find the string terminator
		while(t[ind]!=0 && ind<maxlen)
		{
			if(t[ind]=='%')
				*(unsigned char *)&t[ind]='P';//just remove chars that could be interpreted
			ind++;
		}
	}
	msg.body = t;


	if( itemcount > 12 )
	{
		//SystemMessage("Sorry, Ascent does not support sending multiple items at this time. (don't want to lose your item do you) Remove some items, and try again.");
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		return;
	}

	// Search for the recipient
	PlayerInfo* player = ObjectMgr::getSingleton().GetPlayerInfoByName(recepient.c_str());
	if( player == NULL )
	{
		SendMailError( MAIL_ERR_RECIPIENT_NOT_FOUND );
		return;
	}

	for( i = 0; i < itemcount; ++i )
	{
		recv_data >> itemslot;
		recv_data >> itemguid;

        pItem = _player->GetItemInterface()->GetItemByGUID( itemguid );
		uint32 real_item_slot = _player->GetItemInterface()->GetInventorySlotByGuid( itemguid );
		if( pItem == NULL || pItem->IsSoulbound() || pItem->HasFlag( ITEM_FIELD_FLAGS, ITEM_FLAG_CONJURED ) || 
			( pItem->IsContainer() && SafeContainerCast(pItem)->HasItems() ) || real_item_slot >= 0 && real_item_slot < INVENTORY_SLOT_ITEM_START )
		{
			SendMailError( MAIL_ERR_INTERNAL_ERROR );
			return;
		}
		if(pItem->IsAccountbound() && GetAccountId() !=  player->acct) // don't mail account-bound items to another account
		{
//			SendMailError( MAIL_ERR_INTERNAL_ERROR );
			sStackWolrdPacket( data, SMSG_SEND_MAIL_RESULT, 20 );
			data << uint32(0);
			data << uint32(0); 
			data << uint32(MAIL_ERR_BAG_FULL); 
			data << uint32(INV_ERR_ARTEFACTS_ONLY_FOR_OWN_CHARACTERS); 
			SendPacket(&data);
			return;
		}

		items.push_back( pItem );
	}
	
	recv_data >> msg.money;
	recv_data >> msg.cod;
	// left over: (TODO- FIX ME BURLEX!)
	// uint32
	// uint32
	// uint8
	
	bool interfaction = false;
	if( sMailSystem.MailOption( MAIL_FLAG_CAN_SEND_TO_OPPOSITE_FACTION ) || (HasGMPermissions() && sMailSystem.MailOption( MAIL_FLAG_CAN_SEND_TO_OPPOSITE_FACTION_GM ) ) )
	{
		interfaction = true;
	}

	// Check we're sending to the same faction (disable this for testing)
	if( player->team != _player->GetTeam() && !interfaction )
	{
		SendMailError( MAIL_ERR_NOT_YOUR_ALLIANCE );
		return;
	}

	// Check if we're sending mail to ourselves
	if( strcmp(player->name, _player->GetName()) == 0 && !GetPermissionCount())
	{
		SendMailError(MAIL_ERR_CANNOT_SEND_TO_SELF);
		return;
	}

	if( msg.stationery == MAIL_STATIONERY_GM && !HasGMPermissions())
	{
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		return;
	}

	// Instant delivery time by default.
	msg.delivery_time = (uint32)UNIXTIME;

	// Set up the cost
	int32 cost = 0;

	// Check for attached money
	if( msg.money > 0 )
		cost += msg.money;

	if( cost < 0 )
	{
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		return;
	}

	if( !sMailSystem.MailOption( MAIL_FLAG_DISABLE_POSTAGE_COSTS ) && !( GetPermissionCount() && sMailSystem.MailOption( MAIL_FLAG_NO_COST_FOR_GM ) ) )
	{
		cost += 30;
		if( cost < 30 )//Overflow prevention for those silly WPE hoez.
		{
			SendMailError(MAIL_ERR_INTERNAL_ERROR);
			return;
		}			
	}	

	// check that we have enough in our backpack
	if( (int32)_player->GetGold( ) < cost )
	{
		SendMailError( MAIL_ERR_NOT_ENOUGH_MONEY );
		return;
	}
	_player->Event_Achiement_Received(ACHIEVEMENT_CRITERIA_TYPE_GOLD_SPENT_FOR_MAIL,ACHIEVEMENT_UNUSED_FIELD_VALUE,ACHIEVEMENT_UNUSED_FIELD_VALUE,30,ACHIEVEMENT_EVENT_ACTION_ADD);

	// Check for the item, and required item.
	if( !items.empty( ) )
	{
		for( itr = items.begin(); itr != items.end(); ++itr )
		{
			pItem = *itr;
			if( _player->GetItemInterface()->SafeRemoveAndRetreiveItemByGuid(pItem->GetGUID(), false) != pItem )
				continue;		// should never be hit.

			pItem->RemoveFromWorld();
			pItem->SetOwner( NULL );
			pItem->SaveToDB( INVENTORY_SLOT_NOT_SET, 0, true, NULL );
			msg.items.push_back( pItem->GetUInt32Value(OBJECT_FIELD_GUID) );

			if( GetPermissionCount() > 0 )
			{
				/* log the message */
				sGMLog.writefromsession(this, "sent mail with item entry %u to %s, with gold %u.", pItem->GetEntry(), player->name, msg.money);
			}

			pItem->DeleteMe();
			pItem = NULL;
		}
	}

	if(msg.money != 0 || msg.cod != 0 || !msg.items.size() && player->acct != _player->GetSession()->GetAccountId())
	{
		if(!sMailSystem.MailOption(MAIL_FLAG_DISABLE_HOUR_DELAY_FOR_ITEMS))
			msg.delivery_time += 3600;  // 1hr
	}

	// take the money
	_player->ModGold( -cost);

	// Fill in the rest of the info
	msg.player_guid = player->guid;
	msg.sender_guid = _player->GetGUID();
	
	// 30 day expiry time for unread mail mail
	if(!sMailSystem.MailOption(MAIL_FLAG_NO_EXPIRY))
		msg.expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
	else
		msg.expire_time = 0;

	msg.copy_made = false;
	msg.read_flag = false;
	msg.deleted_flag = false;
	msg.message_type = 0;

	// Great, all our info is filled in. Now we can add it to the other players mailbox.
	sMailSystem.DeliverMessage(player->guid, &msg);
	// Save/Update character's gold if they've recieved gold that is. This prevents a rollback.
	CharacterDatabase.Execute("UPDATE `characters` SET `gold`='%u' WHERE (`guid`='%u')", _player->GetUInt32Value(PLAYER_FIELD_COINAGE), _player->m_playerInfo->guid);
	// Success packet :)
	SendMailError(MAIL_OK);
#if GM_STATISTICS_UPDATE_INTERVAL > 0 
	if( GetPlayer()->m_GM_statistics )
		GetPlayer()->m_GM_statistics->mails_sent++;
#endif
}

void WorldSession::HandleMarkAsRead(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0) 
	{ 
		return;
	}

	// mark the message as read
	message->read_flag = 1;

  // mail now has a minimum expiry time of 3 days and a maximum expiry time of 30 days
	if(!sMailSystem.MailOption(MAIL_FLAG_NO_EXPIRY))
  {
    if(message->expire_time > ((uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME)))
		  message->expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
    if(message->expire_time < ((uint32)UNIXTIME + (TIME_DAY * 3)))
      message->expire_time = (uint32)UNIXTIME + (TIME_DAY * 3);
  }
	
	// update it in sql
	CharacterDatabase.WaitExecute("UPDATE mailbox SET read_flag = 1, expiry_time = %u WHERE message_id = %u", message->expire_time, message->message_id);

  //TODO: Send changes to player... (read-mark and expiry time changed..)
}

void WorldSession::HandleMailDelete(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_DELETED);

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

	if(message->copy_made)
	{
		// we have the message as a copy on the item. we can't delete it or this item
		// will no longer function.

		// deleted_flag prevents it from being shown in the mail list.
		message->deleted_flag = 1;

		// update in sql
		CharacterDatabase.WaitExecute("UPDATE mailbox SET deleted_flag = 1 WHERE message_id = %u", message_id);
	}
	else
	{
		// delete the message, there are no other references to it.
		_player->m_mailBox.DeleteMessage(message_id, true);
	}

	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleTakeItem(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	uint32 lowguid;
	vector< uint64 >::iterator itr;

	recv_data >> mailbox >> message_id >> lowguid;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_ITEM_TAKEN);
	
	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || message->items.empty())
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

	for( itr = message->items.begin( ); itr != message->items.end( ); ++itr )
	{
		if ( (*itr) == lowguid )
			break;
	}

	if( itr == message->items.end( ) )
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

	// check for cod credit
	if(message->cod > 0)
	{
		if(_player->GetGold() < message->cod)
		{
			data << uint32(MAIL_ERR_NOT_ENOUGH_MONEY);
			SendPacket(&data);
			return;
		}
	}

	// grab the item
	Item * item = objmgr.LoadItem( *itr );
	if(item == 0)
	{
		// doesn't exist
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);
		
		return;
	}

	// find a free bag slot
	SlotResult result = _player->GetItemInterface()->FindFreeInventorySlot(item->GetProto());
	if(result.Result == 0)
	{
		// no free slots left!
		data << uint32(MAIL_ERR_BAG_FULL);
		SendPacket(&data);

		item->DeleteMe();
		return;
	}

	// all is good
	// delete the item (so when its resaved it'll have an association)
	item->DeleteFromDB();

	// add the item to their backpack
	item->m_isDirty = true;

	// send complete packet
	data << uint32(MAIL_OK);
	data << item->GetUInt32Value(OBJECT_FIELD_GUID);
	data << item->GetUInt32Value(ITEM_FIELD_STACK_COUNT);

	if( !_player->GetItemInterface()->AddItemToFreeSlot(&item) )
	{
		item->DeleteMe();
		item = NULL;
	}

	message->items.erase( itr );

	// re-save (update the items field)
	sMailSystem.SaveMessageToSQL( message);
	SendPacket(&data);
	
	if( message->cod > 0 )
	{
		_player->ModGold( -int32(message->cod));
		string subject = "COD Payment: ";
		subject += message->subject;
		sMailSystem.SendAutomatedMessage(NORMAL, message->player_guid, message->sender_guid, subject, "", message->cod, 0, 0, MAIL_STATIONERY_TEST1 );

		message->cod = 0;
		CharacterDatabase.Execute("UPDATE mailbox SET cod = 0 WHERE message_id = %u", message->message_id);
	}

	// prolly need to send an item push here
}

void WorldSession::HandleTakeMoney(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_MONEY_TAKEN);

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || !message->money)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

	// add the money to the player
	_player->ModGold( message->money);

	// message no longer has any money
	message->money = 0;

	// update in sql!
	CharacterDatabase.WaitExecute("UPDATE mailbox SET money = 0 WHERE message_id = %u", message->message_id);

	// send result
	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleReturnToSender(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_RETURNED_TO_SENDER);

	MailMessage * msg = _player->m_mailBox.GetMessage(message_id);
	if(msg == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}
	
	// copy into a new struct
	MailMessage message = *msg;

	// remove the old message
	_player->m_mailBox.DeleteMessage(message_id, true);

	// re-assign the owner/sender
	message.player_guid = message.sender_guid;
	message.sender_guid = _player->GetGUID();

	// turn off the read flag
	message.read_flag = false;
	message.deleted_flag = false;
	message.copy_made = false;

	// null out the cod charges. (the sender doesnt want to have to pay for his own item
	// that he got nothing for.. :p)
	message.cod = 0;

	// assign new delivery time
	message.delivery_time = message.items.empty() ? (uint32)UNIXTIME : (uint32)UNIXTIME + 3600;

	// add to the senders mailbox
	sMailSystem.DeliverMessage(message.player_guid, &message);

	// finish the packet
	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleMailCreateTextItem(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_MADE_PERMANENT);

	ItemPrototype * proto = ItemPrototypeStorage.LookupEntry(8383);
	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || !proto)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

	SlotResult result = _player->GetItemInterface()->FindFreeInventorySlot(proto);
	if(result.Result == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);

		return;
	}

/*	
	3.3 is missing this
	Item * pItem = objmgr.CreateItem(8383, _player);
	pItem->SetUInt32Value(ITEM_FIELD_ITEM_TEXT_ID, message_id);
	if( _player->GetItemInterface()->AddItemToFreeSlot(&pItem) )
	{
		// mail now has an item after it
		message->copy_made = true;

		// update in sql
		CharacterDatabase.WaitExecute("UPDATE mailbox SET copy_made = 1 WHERE message_id = %u", message_id);

		data << uint32(MAIL_OK);
		SendPacket(&data);
	}
	else
	{
		pItem->DeleteMe();
	} */
}

void WorldSession::HandleItemTextQuery(WorldPacket & recv_data)
{
	uint32 message_id;
	recv_data >> message_id;

	string body = "Internal Error";

	MailMessage * msg = _player->m_mailBox.GetMessage(message_id);
	if(msg)
		body = msg->body;

	WorldPacket data(SMSG_ITEM_TEXT_QUERY_RESPONSE, body.length() + 5);
	data << message_id << body;
	SendPacket(&data);
}

void Mailbox::FillTimePacket(WorldPacket& data)
{
	/*
	!! for 24 mails not 1
{SERVER} Packet: (0x0284) MSG_QUERY_NEXT_MAIL_TIME PacketSize = 32 TimeStamp = 31642665
00 00 00 00
01 00 00 00 
6E DD FC 01 00 00 00 04 
00 00 00 00
00 00 00 00
29 00 00 00
00 00 58 C2 - 52 as float -> 52 seconds ?
*/
	uint32 c = 0;
	MessageMap::iterator iter = Messages.begin();
	data << uint32(0) << uint32(0);

	for(; iter != Messages.end(); ++iter)
	{
		if(iter->second.deleted_flag == 0 && iter->second.read_flag == 0 && (uint32)UNIXTIME >= iter->second.delivery_time)
		{
			// unread message, w00t.
			++c;
			data << uint64(iter->second.sender_guid);
			data << uint32(0);
			data << uint32(iter->second.message_type);
			data << uint32(iter->second.stationery);
			data << float(UNIXTIME-iter->second.delivery_time);
			//Zack : blizz sends only 1 maybe we should send all ?
			break ;
		}
	}

	if(c==0)
	{
/*
{SERVER} Packet: (0x0284) MSG_QUERY_NEXT_MAIL_TIME PacketSize = 8 TimeStamp = 31448225
00 C0 A8 C7 
00 00 00 00 
*/
		*(uint32*)(&data.contents()[0])=0xc7a8c000;
	}
	else
	{
		*(uint32*)(&data.contents()[4])=c;
	}
}

void WorldSession::HandleMailTime(WorldPacket & recv_data)
{
	WorldPacket data(MSG_QUERY_NEXT_MAIL_TIME, 100);
	_player->m_mailBox.FillTimePacket(data);
	SendPacket(&data);
}

void WorldSession::SendMailError(uint32 error)
{
	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << uint32(0);
	data << uint32(MAIL_RES_MAIL_SENT);
	data << error;
	SendPacket(&data);
}

void WorldSession::HandleGetMail(WorldPacket & recv_data )
{
	WorldPacket * data = _player->m_mailBox.BuildMailboxListingPacket();
	SendPacket(data);
	delete data;
	data = NULL;
}

void MailSystem::RemoveMessageIfDeleted(uint32 message_id, Player * plr)
{
	MailMessage * msg = plr->m_mailBox.GetMessage(message_id);
	if(msg == 0) 
	{ 
		return;
	}

	if(msg->deleted_flag)   // we've deleted from inbox
		plr->m_mailBox.DeleteMessage(message_id, true);   // wipe the message
}

void MailSystem::SendAutomatedMessage(uint32 type, uint64 sender, uint64 receiver, string subject, string body,
									  uint32 money, uint32 cod, uint64 item_guid, uint32 stationery)
{
	// This is for sending automated messages, for example from an auction house.
	MailMessage msg;
	msg.message_type = type;
	msg.sender_guid = sender;
	msg.player_guid = receiver;
	msg.subject = subject;
	msg.body = body;
	msg.money = money;
	msg.cod = cod;
	if( GUID_LOPART(item_guid) != 0 )
		msg.items.push_back( GUID_LOPART(item_guid) );

	msg.stationery = stationery;
	msg.delivery_time = (uint32)UNIXTIME;
	msg.expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
	msg.read_flag = false;
	msg.copy_made = false;
	msg.deleted_flag = false;

	// Send the message.
	DeliverMessage(receiver, &msg);
}

uint32 MailSystem::Generate_Message_Id()
{
	/** I know this is horrible. But when you have external mail sources unfortunately this is the only way to do this.
	 * - Burlex
	 */

	uint32 id = 1;
	QueryResult * result = CharacterDatabase.Query("SELECT MAX(message_id) FROM mailbox");
	if(result)
	{
		id = result->Fetch()[0].GetUInt32()+1;
		delete result;
		result = NULL;
	}

	return id;
}

void Mailbox::Load(QueryResult * result)
{
	if(!result)
	{ 
		return;
	}

	Field * fields;
	MailMessage msg;
	uint32 i;
	char * str;
	char * p;
	uint64 itemguid;

	do 
	{
		fields = result->Fetch();

		// Create message struct
		i = 0;
		msg.items.clear();
		msg.message_id = fields[i++].GetUInt32();
		msg.message_type = fields[i++].GetUInt32();
		msg.player_guid = fields[i++].GetUInt32();
		msg.sender_guid = fields[i++].GetUInt32();
		msg.subject = fields[i++].GetString();
		msg.body = fields[i++].GetString();
		msg.money = fields[i++].GetUInt32();
		str = (char*)fields[i++].GetString();
		p = strchr(str, ',');
		if( p == NULL )
		{
			itemguid = atoi(str);
			if( itemguid != 0 )
				msg.items.push_back( itemguid );
		}
		else
		{
			while( p )
			{
				*p = 0;
				p++;

				itemguid = atoi( str );
				if( itemguid != 0 )
					msg.items.push_back( itemguid );

                str = p;
				p = strchr( str, ',' );
			}
		}

		msg.cod = fields[i++].GetUInt32();
		msg.stationery = fields[i++].GetUInt32();
		msg.expire_time = fields[i++].GetUInt32();
		msg.delivery_time = fields[i++].GetUInt32();
		msg.copy_made = fields[i++].GetBool();
		msg.read_flag = fields[i++].GetBool();
		msg.deleted_flag = fields[i++].GetBool();

		if( msg.deleted_flag ) // cebernic : code for explito itemdupe
		{
			CharacterDatabase.Execute( "DELETE FROM mailbox WHERE message_id = %u", msg.message_id );
			continue;
		}
		else
		{
			msg.copy_made = false;
			CharacterDatabase.Execute( "UPDATE mailbox SET copy_made = 0 WHERE message_id = %u", msg.message_id	);
		}

		// Add to the mailbox
		AddMessage(&msg);

	} while(result->NextRow());
}
